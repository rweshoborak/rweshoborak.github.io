{% extends 'base.html' %}

{% block title %}Manage Member - Ujirani Mwema{% endblock %}

{% block content %}
<h2>Manage Member: {{ member.user.get_full_name }}</h2>

<div class="stats">
    <div class="stat-card">
        <h3>ID Number</h3>
        <div class="value">{{ member.id_number }}</div>
    </div>
    <div class="stat-card">
        <h3>Total Paid</h3>
        <div class="value">TZS {{ total_paid|floatformat:0 }}</div>
    </div>
    <div class="stat-card">
        <h3>Unpaid Months</h3>
        <div class="value">{{ unpaid_months|length }}</div>
    </div>
</div>

<div class="grid">
    <!-- Add Single Contribution -->
    <div class="card">
        <h3>Add Single Contribution</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_contribution">

            <div class="form-group">
                <label for="year">Year</label>
                <input type="number" id="year" name="year" value="{{ current_year }}" required>
            </div>

            <div class="form-group">
                <label for="month">Month</label>
                <select id="month" name="month" required>
                    <option value="">Select Month</option>
                    {% for month_num, month_name in months %}
                    <option value="{{ month_num }}">{{ month_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="amount">Amount (TZS)</label>
                <input type="number" id="amount" name="amount" value="{{ group.monthly_contribution }}" required>
            </div>

            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Add any notes about this payment"></textarea>
            </div>

            <button type="submit" class="btn btn-success" style="width: 100%;">Add Contribution</button>
        </form>
    </div>

    <!-- Bulk Payment Distribution -->
    <div class="card">
        <h3>Bulk Payment Distribution</h3>
        {% if unpaid_months %}
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="bulk_payment">

            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <p style="margin: 0; font-size: 0.9rem;">
                    <strong>Unpaid months:</strong>
                </p>
                <p style="margin: 0.5rem 0 0 0; color: #666;">
                    {% for year, month in unpaid_months %}
                        {% for m_num, m_name in months %}
                            {% if m_num == month %}{{ m_name }} {{ year }}{% endif %}
                        {% endfor %}
                        {% if not forloop.last %}<br>{% endif %}
                    {% endfor %}
                </p>
            </div>

            <div class="form-group">
                <label for="total_amount">Total Amount to Distribute (TZS)</label>
                <input type="number" id="total_amount" name="total_amount" required placeholder="e.g., 15000">
                <small style="color: #666;">Will distribute as TZS {{ group.monthly_contribution }} per month</small>
            </div>

            <button type="submit" class="btn btn-success" style="width: 100%;">Distribute Payment</button>
        </form>
        {% else %}
        <div style="background: #d4edda; padding: 1rem; border-radius: 4px; color: #155724;">
            <p>✓ No unpaid months for this member. All contributions are up to date!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Payment History -->
<div class="card">
    <h3>Payment History</h3>
    {% if paid_contributions %}
    <table class="table">
        <thead>
            <tr>
                <th>Month</th>
                <th>Year</th>
                <th>Amount</th>
                <th>Paid Date</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for contribution in paid_contributions %}
            <tr>
                <td>{{ contribution.get_month_name }}</td>
                <td>{{ contribution.year }}</td>
                <td>TZS {{ contribution.amount|floatformat:0 }}</td>
                <td>{{ contribution.paid_date|date:"d-m-Y" }}</td>
                <td>{{ contribution.notes|truncatewords:10 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No payment history yet.</p>
    {% endif %}
</div>

<div style="margin-top: 2rem;">
    <a href="{% url 'accountant_dashboard' %}" class="btn btn-secondary">← Back to Dashboard</a>
</div>
{% endblock %}
